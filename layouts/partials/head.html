{{- /*
    一份全面的、专业的 Hugo SEO Partial (已增强)
    这个文件负责处理所有与搜索引擎优化相关的元数据，包括：
    1.  页面标题 (<title>)
    2.  Meta Description
    3.  规范化URL (Canonical URL)
    4.  社交媒体分享 (Open Graph)
    5.  Twitter Cards (可选，可禁用)
    6.  结构化数据 (JSON-LD for Google Rich Snippets)
    7.  搜索引擎指令 (Robots meta tag)
    8.  【新增】Bing 网站管理员工具验证
    9.  【新增】Microsoft Application Tiles (Windows磁贴)
*/ -}}

{{- $page := . }}
{{- $site := .Site }}

{{- /* ============================================= */ -}}
{{- /*            变量定义与逻辑处理                */ -}}
{{- /* ============================================= */ -}}
{{- $title := cond $page.IsHome $site.Title (printf "%s | %s" $page.Title $site.Title) }}
{{- $description := $page.Params.description | default ($page.Summary | plainify | truncate 160) | default $site.Params.description | default "Welcome to our website!" | trim "\n" }}
{{- $image := absURL ($page.Params.image | default $site.Params.logo) }}


{{- /* ============================================= */ -}}
{{- /*              HTML Head 输出部分              */ -}}
{{- /* ============================================= */ -}}

<head>
    <!-- 1. 页面标题 -->
    <title>{{ $title }}</title>

    <link rel="icon" type="image/png" href="/logo128x128.png" sizes="128x128" />
    <link rel="icon" type="image/png" href="/logo256x256.png" sizes="256x256" />
    <link rel="icon" type="image/png" href="/logo512x512.png" sizes="512x512" />

    <!-- 2. 标准 Meta 标签 -->
    <meta name="description" content="{{ .Params.description }}">
    <meta name="author" content="{{ .Site.Params.author.name | default "Author" }}">


    <link rel="stylesheet" href="{{ "css/style.css" | relURL }}">

        
    <!-- 2. 引入语法高亮样式 -->
    <link rel="stylesheet" href="{{ "css/syntax.css" | relURL }}">

    <!-- 3. 新增：引入 Markdown 内容样式 -->
    <link rel="stylesheet" href="{{ "css/markdown.css" | relURL }}">

    <!-- 3.1 新增：百度SEO验证 -->
    {{- with .Site.Params.baidu_site_verification -}}
      <meta name="baidu-site-verification" content="{{ . }}" />
    {{- end -}}

    <!-- 3. Canonical URL: 告诉搜索引擎这是内容的“官方”版本 -->
    <link rel="canonical" href="{{ $page.Permalink }}">

    <!-- 4. Robots Meta Tag: 控制搜索引擎爬虫的行为 -->
    {{- if eq (hugo.Environment) "production" }}
        {{- $robots := cond (or $page.Params.noindex $page.Params.draft) "noindex, nofollow" "index, follow" }}
        <meta name="robots" content="{{ $robots }}">
    {{ else }}
        <meta name="robots" content="noindex, nofollow">
    {{- end }}

    <!-- 5. Open Graph (OG) 协议标签: 对 Bing, Facebook, LinkedIn 等都至关重要 -->
    <meta property="og:title" content="{{ $page.Title | default $site.Title }}">
    <meta property="og:description" content="{{ $description }}">
    <meta property="og:type" content="{{ if $page.IsPage }}article{{ else }}website{{ end }}">
    <meta property="og:url" content="{{ $page.Permalink }}">
    <meta property="og:site_name" content="{{ $site.Title }}">
    {{- with $image }}<meta property="og:image" content="{{ . }}">{{- end }}
    {{- if $page.IsPage }}
    <meta property="article:published_time" content="{{ $page.Date.Format "2006-01-02T15:04:05-07:00" }}">
    <meta property="article:modified_time" content="{{ $page.Lastmod.Format "2006-01-02T15:04:05-07:00" }}">
    {{- end }}

    <!-- 6. JSON-LD 结构化数据: Google 和 Bing 都支持，用于生成富媒体摘要 -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "{{ if .IsPage }}Article{{ else }}WebSite{{ end }}",
        "headline": "{{ $page.Title | default $site.Title }}",
        "name": "{{ $page.Title | default $site.Title }}",
        "description": "{{ $description }}",
        "url": "{{ $page.Permalink }}",
        {{- if $page.IsPage }}
        "datePublished": "{{ $page.Date.Format "2006-01-02T15:04:05-07:00" }}",
        "dateModified": "{{ $page.Lastmod.Format "2006-01-02T15:04:05-07:00" }}",
        "author": { "@type": "Person", "name": "{{ $site.Params.author | default "Author" }}" },
        {{- end }}
        "publisher": {
            "@type": "Organization",
            "name": "{{ $site.Title }}",
            "logo": { "@type": "ImageObject", "url": "{{ absURL $site.Params.logo }}" }
        }
    }
    </script>

    {{/* --- Theme Switcher: No-Flash Script --- */}}
    <script>
        (function() {
            // 检查 localStorage 中是否有已保存的主题偏好
            const savedTheme = localStorage.getItem('theme');
            // 检查用户的操作系统是否偏好暗色模式
            const osPrefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

            // 如果用户选择了 'dark'，或者没有选择但系统偏好是 'dark'，则应用暗色模式
            if (savedTheme === 'dark' || (!savedTheme && osPrefersDark)) {
                document.documentElement.classList.add('dark-mode');
            }
        })();
    </script>

    {{/* --- 引入主题切换的 JS 文件 --- */}}
    <script src="{{ "js/theme-switcher.js" | relURL }}" defer></script>


    {{/* --- 引入代码块复制的 JS 文件 --- */}}
    <script src="{{ "js/copy-code.js" | relURL }}" defer></script>

    {{/* 如果页面参数 katex 为 true，则加载 KaTeX 模板 */}}
    {{ if .Params.math }}
      {{ partial "mathjax.html" . }}
    {{ end }}

</head>

